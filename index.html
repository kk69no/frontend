<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>P2P Counter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f8;
      margin: 0;
      padding: 1rem;
    }
    .container {
      max-width: 650px;
      margin: auto;
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .circle-card {
      background: #fafafa;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: relative;
    }
    .circle-card h3 {
      margin: 0 0 0.5rem;
    }
    .circle-card button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
    }
    .progress-bar {
      height: 14px;
      border-radius: 8px;
      overflow: hidden;
      background: #eee;
      margin: 0.5rem 0;
    }
    .progress-bar-inner {
      height: 100%;
      background-color: #4caf50;
      transition: width 0.2s ease;
    }
    .btn-small {
      padding: 0.4rem 0.7rem;
      font-size: 0.9rem;
    }
    .analytics {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>P2P-—Å–¥–µ–ª–∫–∞</h1>
    <label for="type">–¢–∏–ø —Å–¥–µ–ª–∫–∏</label>
    <select id="type">
      <option value="buy">–ü–æ–∫—É–ø–∫–∞</option>
      <option value="sell">–ü—Ä–æ–¥–∞–∂–∞</option>
    </select>

    <label for="circleSelect">–í—ã–±—Ä–∞—Ç—å –∫—Ä—É–≥</label>
    <select id="circleSelect"></select>

    <label for="amount">–°—É–º–º–∞</label>
    <input type="number" id="amount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (‚ÇΩ)">

    <div class="quick-buttons">
      <button onclick="adjustAmount(1)">+1</button>
      <button onclick="adjustAmount(10)">+10</button>
      <button onclick="adjustAmount(100)">+100</button>
    </div>

    <label for="currency">–í–∞–ª—é—Ç–∞</label>
    <input type="text" id="currency" placeholder="–ü—Ä–∏–º–µ—Ä: USDT">

    <label for="price">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
    <input type="number" id="price" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É">

    <label for="note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
    <input type="text" id="note" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Binance">

    <div class="actions">
      <button id="suggestNote">AI-–ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
      <button id="addDeal">–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
    </div>

    <div id="circles"></div>
    <div class="analytics" id="analytics"></div>
  </div>

<script>
const API_BASE = "https://backend-2wm0.onrender.com";
let userId = null;
let circles = [];

window.Telegram.WebApp.ready();
userId = Telegram.WebApp.initDataUnsafe?.user?.id || 0;

async function fetchCircles() {
  const res = await fetch(`${API_BASE}/circles?user_id=${userId}`);
  circles = await res.json();
  updateCircleSelect();
  updateCirclesUI();
  updateAnalytics();
}

function updateCircleSelect() {
  const sel = document.getElementById("circleSelect");
  sel.innerHTML = "";
  circles.forEach((c, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `–ö—Ä—É–≥ #${i+1} (${c.closed ? '–ó–∞–∫—Ä—ã—Ç' : '–û—Ç–∫—Ä—ã—Ç'})`;
    sel.appendChild(opt);
  });
}

function updateCirclesUI() {
  const cont = document.getElementById("circles");
  cont.innerHTML = "";
  circles.forEach((c, i) => {
    const buy = parseFloat(c.buyAmount);
    const rem = parseFloat(c.remaining);
    const sold = buy - rem;
    const pct = (sold / buy) * 100;

    const card = document.createElement("div");
    card.className = "circle-card";
    card.innerHTML = `
      <h3>–ö—Ä—É–≥ #${i+1}</h3>
      <div>–ü–æ–∫—É–ø–∫–∞: ${buy}‚ÇΩ</div>
      <div>–ü—Ä–æ–¥–∞–Ω–æ: ${sold.toFixed(2)}‚ÇΩ</div>
      <div>–°—Ç–∞—Ç—É—Å: ${c.closed ? '‚úÖ –ó–∞–∫—Ä—ã—Ç' : 'üïì –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}</div>
      <div class="progress-bar">
        <div class="progress-bar-inner" style="width: ${pct}%"></div>
      </div>
      <ul>${c.sells.map(s => `<li>${s.amount}‚ÇΩ ‚Äî ${s.currency} –ø–æ ${s.price}‚ÇΩ (${s.note})</li>`).join('')}</ul>
      <button class="btn-small" onclick="deleteCircle(${c.id})">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    cont.appendChild(card);
  });
}

async function deleteCircle(id) {
  if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—Ä—É–≥?")) {
    await fetch(`${API_BASE}/circles/${id}?user_id=${userId}`, { method: 'DELETE' });
    await fetchCircles();
  }
}

function updateAnalytics() {
  const totalBuys = circles.reduce((sum, c) => sum + parseFloat(c.buyAmount), 0);
  const totalSells = circles.reduce((sum, c) => sum + (parseFloat(c.buyAmount) - parseFloat(c.remaining)), 0);
  document.getElementById("analytics").innerHTML = `
    <h3>–û—Ç—á—ë—Ç</h3>
    <p>–í—Å–µ–≥–æ –∫—Ä—É–≥–æ–≤: ${circles.length}</p>
    <p>–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫: ${totalBuys.toFixed(2)}‚ÇΩ</p>
    <p>–û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂: ${totalSells.toFixed(2)}‚ÇΩ</p>
    <p>–û—Ç–∫—Ä—ã—Ç—ã–µ –∫—Ä—É–≥–∏: ${circles.filter(c=>!c.closed).length}</p>
    <p>–ó–∞–∫—Ä—ã—Ç—ã–µ –∫—Ä—É–≥–∏: ${circles.filter(c=>c.closed).length}</p>`;
}

function adjustAmount(val) {
  const input = document.getElementById("amount");
  input.value = parseFloat(input.value || 0) + val;
}

document.getElementById("suggestNote").addEventListener("click", () => {
  const currency = document.getElementById("currency").value || "USDT";
  const price = document.getElementById("price").value || "100";
  document.getElementById("note").value = `–°–¥–µ–ª–∫–∞ –≤ ${currency}, ${price}`;
});

document.getElementById("addDeal").addEventListener("click", async () => {
  const type = document.getElementById("type").value;
  const amount = +document.getElementById("amount").value;
  const currency = document.getElementById("currency").value;
  const price = +document.getElementById("price").value;
  const note = document.getElementById("note").value;

  if (!amount || !currency || !price) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");

  if (type === "buy") {
    await fetch(`${API_BASE}/circles`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ buyAmount: amount, user_id: userId })
    });
  } else {
    const c = circles[document.getElementById("circleSelect").value];
    if (!c || c.closed) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä—É–≥");
    await fetch(`${API_BASE}/circles/${c.id}/sells`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ amount, currency, price, note, user_id: userId })
    });
  }

  ["amount","currency","price","note"].forEach(id => document.getElementById(id).value = "");
  await fetchCircles();
});

window.addEventListener("DOMContentLoaded", fetchCircles);
</script>
</body>
</html>
