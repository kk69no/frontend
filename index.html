<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P —Å–¥–µ–ª–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: var(--tg-theme-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000);
      margin: 0;
      padding: 1rem;
    }
    .container {
      max-width: 700px;
      margin: auto;
    }
    input, select {
      width: 100%;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 0.5rem 1rem;
      border: none;
      background: var(--tg-theme-button-color, #2a85ff);
      color: var(--tg-theme-button-text-color, #fff);
      border-radius: 6px;
      cursor: pointer;
      margin-top: 0.4rem;
      margin-right: 0.4rem;
    }
    .card {
      background: var(--tg-theme-secondary-bg-color, #fff);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 10px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    canvas {
      width: 100% !important;
      max-height: 180px;
      margin-top: 0.5rem;
    }
    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>P2P —Å–¥–µ–ª–∫–∏</h2>

    <label>–¢–∏–ø —Å–¥–µ–ª–∫–∏</label>
    <select id="type">
      <option value="buy">–ü–æ–∫—É–ø–∫–∞</option>
      <option value="sell">–ü—Ä–æ–¥–∞–∂–∞</option>
    </select>

    <input id="amount" type="number" placeholder="–°—É–º–º–∞ ‚ÇΩ">
    <input id="currency" type="text" placeholder="–í–∞–ª—é—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, USDT)">
    <input id="price" type="number" placeholder="–¶–µ–Ω–∞ ‚ÇΩ">
    <input id="note" type="text" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Binance)">
    <button onclick="startVoice()">üéô –ì–æ–≤–æ—Ä–∏—Ç—å</button>
    <button onclick="aiNote()">AI-–ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
    <button onclick="addDeal()">–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</button>

    <label>–ö—Ä—É–≥ (–¥–ª—è –ø—Ä–æ–¥–∞–∂–∏)</label>
    <select id="circleSelect"></select>

    <div class="filters">
      <input type="text" id="filterCurrency" placeholder="–§–∏–ª—å—Ç—Ä: –í–∞–ª—é—Ç–∞">
      <input type="number" id="filterMinPrice" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞">
      <input type="number" id="filterMaxPrice" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞">
    </div>

    <div id="circles"></div>
  </div>

  <script>
    const API = "https://backend-2wm0.onrender.com";
    Telegram.WebApp.ready();
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id;

    let circles = [];

    async function loadCircles() {
      const res = await fetch(`${API}/circles?user_id=${userId}`);
      circles = await res.json();
      renderUI();
    }

    function renderUI() {
      const list = document.getElementById("circles");
      list.innerHTML = "";
      const select = document.getElementById("circleSelect");
      select.innerHTML = "";

      const fCurrency = document.getElementById("filterCurrency").value.toLowerCase();
      const minP = +document.getElementById("filterMinPrice").value || 0;
      const maxP = +document.getElementById("filterMaxPrice").value || Infinity;

      circles.forEach((c, i) => {
        const sold = parseFloat(c.buyAmount) - parseFloat(c.remaining);
        const revenue = c.sells.reduce((sum, s) => sum + (s.amount * s.price), 0);
        const pnl = revenue - c.buyAmount;
        const percent = (sold / c.buyAmount) * 100;

        // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        const filteredSells = c.sells.filter(s =>
          s.currency.toLowerCase().includes(fCurrency) &&
          s.price >= minP && s.price <= maxP
        );

        const opt = document.createElement("option");
        opt.value = i;
        opt.text = `–ö—Ä—É–≥ #${i + 1}`;
        select.appendChild(opt);

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h3>–ö—Ä—É–≥ #${i + 1}</h3>
          <p>–ü–æ–∫—É–ø–∫–∞: ${c.buyAmount}‚ÇΩ | –ü—Ä–æ–¥–∞–Ω–æ: ${sold.toFixed(2)}‚ÇΩ</p>
          <p>–í—ã—Ä—É—á–∫–∞: ${revenue.toFixed(2)}‚ÇΩ | PnL: ${pnl.toFixed(2)}‚ÇΩ (${(pnl / c.buyAmount * 100).toFixed(1)}%)</p>
          <p>–°—Ç–∞—Ç—É—Å: ${c.closed ? "‚úÖ –ó–∞–∫—Ä—ã—Ç" : "üïì –û—Ç–∫—Ä—ã—Ç"}</p>
          <button onclick="deleteCircle(${c.id})">–£–¥–∞–ª–∏—Ç—å –∫—Ä—É–≥</button>
          <ul>
            ${filteredSells.map(s => `<li>${s.amount}‚ÇΩ ${s.currency} –ø–æ ${s.price}‚ÇΩ ‚Äî ${s.note}
              <button onclick="editSell(${s.id}, ${c.id})">‚úèÔ∏è</button></li>`).join("")}
          </ul>
          <canvas id="chart_${c.id}"></canvas>
        `;
        list.appendChild(div);

        // Chart.js ‚Äî –≥—Ä–∞—Ñ–∏–∫
        const ctx = document.getElementById(`chart_${c.id}`).getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: c.sells.map((s, idx) => `#${idx + 1}`),
            datasets: [{
              label: "‚ÇΩ",
              data: c.sells.map(s => s.amount * s.price),
              backgroundColor: 'rgba(75, 192, 192, 0.6)',
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      });
    }

    async function addDeal() {
      const type = document.getElementById("type").value;
      const amount = +document.getElementById("amount").value;
      const currency = document.getElementById("currency").value;
      const price = +document.getElementById("price").value;
      const note = document.getElementById("note").value;

      if (type === "buy") {
        await fetch(`${API}/circles`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ buyAmount: amount, user_id: userId })
        });
      } else {
        const circle = circles[document.getElementById("circleSelect").value];
        await fetch(`${API}/circles/${circle.id}/sells`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount, currency, price, note, user_id: userId })
        });
      }
      await loadCircles();
    }

    async function deleteCircle(id) {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫—Ä—É–≥?")) return;
      await fetch(`${API}/circles/${id}?user_id=${userId}`, { method: "DELETE" });
      await loadCircles();
    }

    async function editSell(sellId, circleId) {
      const circle = circles.find(c => c.id === circleId);
      const sell = circle.sells.find(s => s.id === sellId);
      const amount = prompt("–°—É–º–º–∞", sell.amount);
      const currency = prompt("–í–∞–ª—é—Ç–∞", sell.currency);
      const price = prompt("–¶–µ–Ω–∞", sell.price);
      const note = prompt("–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ", sell.note);
      if (!amount || !currency || !price) return;
      await fetch(`${API}/sells/${sellId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, currency, price, note, user_id: userId })
      });
      await loadCircles();
    }

    async function aiNote() {
      const currency = document.getElementById("currency").value;
      const price = document.getElementById("price").value;
      const res = await fetch(`${API}/note/ai`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ currency, price })
      });
      const data = await res.json();
      document.getElementById("note").value = data.note;
    }

    function startVoice() {
      if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
        return alert("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏");
      }
      const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      rec.lang = 'ru-RU';
      rec.start();
      rec.onresult = function(e) {
        document.getElementById("note").value = e.results[0][0].transcript;
      };
    }

    document.querySelectorAll('.filters input').forEach(i => i.addEventListener("input", renderUI));
    loadCircles();
  </script>
</body>
</html>
