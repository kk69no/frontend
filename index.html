<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P –°–¥–µ–ª–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: var(--tg-theme-bg-color, #f1f1f1);
      color: var(--tg-theme-text-color, #000);
      margin: 0;
      padding: 1rem;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    input, select {
      width: 100%;
      margin-bottom: 0.8rem;
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 6px;
      background: var(--tg-theme-button-color, #2a85ff);
      color: var(--tg-theme-button-text-color, #fff);
      cursor: pointer;
      margin: 0.3rem 0.5rem 0.3rem 0;
    }
    .card {
      background: var(--tg-theme-secondary-bg-color, #fff);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .progress {
      height: 10px;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      margin: 0.5rem 0;
    }
    .progress-inner {
      height: 100%;
      background: #4caf50;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>P2P –°–¥–µ–ª–∫–∏</h2>

    <label>–¢–∏–ø</label>
    <select id="type">
      <option value="buy">–ü–æ–∫—É–ø–∫–∞</option>
      <option value="sell">–ü—Ä–æ–¥–∞–∂–∞</option>
    </select>

    <label>–°—É–º–º–∞</label>
    <input id="amount" type="number" placeholder="‚ÇΩ">

    <label>–í–∞–ª—é—Ç–∞</label>
    <input id="currency" type="text" placeholder="USDT">

    <label>–¶–µ–Ω–∞</label>
    <input id="price" type="number" placeholder="‚ÇΩ">

    <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
    <input id="note" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">

    <label>–ö—Ä—É–≥ (–¥–ª—è –ø—Ä–æ–¥–∞–∂–∏)</label>
    <select id="circleSelect"></select>

    <button onclick="suggestNote()">AI-–ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
    <button onclick="addDeal()">–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</button>

    <div id="circles"></div>
  </div>

  <script>
    const API = "https://backend-2wm0.onrender.com";
    Telegram.WebApp.ready();
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id;

    let circles = [];

    async function loadCircles() {
      const res = await fetch(`${API}/circles?user_id=${userId}`);
      circles = await res.json();
      renderUI();
    }

    function renderUI() {
      const select = document.getElementById("circleSelect");
      select.innerHTML = "";
      const list = document.getElementById("circles");
      list.innerHTML = "";

      circles.forEach((c, i) => {
        const sold = parseFloat(c.buyAmount) - parseFloat(c.remaining);
        const percent = (sold / parseFloat(c.buyAmount)) * 100;

        const opt = document.createElement("option");
        opt.value = i;
        opt.text = `–ö—Ä—É–≥ #${i + 1} (${c.closed ? '–ó–∞–∫—Ä—ã—Ç' : '–û—Ç–∫—Ä—ã—Ç'})`;
        select.appendChild(opt);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>–ö—Ä—É–≥ #${i + 1}</h3>
          <p>–ü–æ–∫—É–ø–∫–∞: ${c.buyAmount}‚ÇΩ | –ü—Ä–æ–¥–∞–Ω–æ: ${sold.toFixed(2)}‚ÇΩ</p>
          <div class="progress"><div class="progress-inner" style="width:${percent}%"></div></div>
          <p>–°—Ç–∞—Ç—É—Å: ${c.closed ? '‚úÖ –ó–∞–∫—Ä—ã—Ç' : 'üïì –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}</p>
          <button onclick="deleteCircle(${c.id})">–£–¥–∞–ª–∏—Ç—å</button>
          <ul>${c.sells.map(s => `
            <li>${s.amount}‚ÇΩ ${s.currency} –ø–æ ${s.price}‚ÇΩ (${s.note})
              <button onclick="editSell(${s.id}, ${c.id})">‚úèÔ∏è</button>
            </li>`).join("")}</ul>
        `;
        list.appendChild(card);
      });
    }

    async function addDeal() {
      const type = document.getElementById("type").value;
      const amount = +document.getElementById("amount").value;
      const currency = document.getElementById("currency").value;
      const price = +document.getElementById("price").value;
      const note = document.getElementById("note").value;

      if (type === "buy") {
        await fetch(`${API}/circles`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ buyAmount: amount, user_id: userId })
        });
      } else {
        const circle = circles[document.getElementById("circleSelect").value];
        if (!circle || circle.closed) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä—É–≥");

        await fetch(`${API}/circles/${circle.id}/sells`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount, currency, price, note, user_id: userId })
        });
      }

      ["amount","currency","price","note"].forEach(id => document.getElementById(id).value = "");
      await loadCircles();
    }

    async function deleteCircle(id) {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫—Ä—É–≥?")) return;
      await fetch(`${API}/circles/${id}?user_id=${userId}`, { method: "DELETE" });
      await loadCircles();
    }

    function suggestNote() {
      const currency = document.getElementById("currency").value;
      const price = document.getElementById("price").value;
      document.getElementById("note").value = `–°–¥–µ–ª–∫–∞ –≤ ${currency}, ${price}`;
    }

    async function editSell(sellId, circleId) {
      const circle = circles.find(c => c.id === circleId);
      const sell = circle.sells.find(s => s.id === sellId);
      if (!sell) return;

      const amount = prompt("–°—É–º–º–∞", sell.amount);
      const currency = prompt("–í–∞–ª—é—Ç–∞", sell.currency);
      const price = prompt("–¶–µ–Ω–∞", sell.price);
      const note = prompt("–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ", sell.note);

      if (!amount || !currency || !price) return;

      await fetch(`${API}/sells/${sellId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, currency, price, note, user_id: userId })
      });

      await loadCircles();
    }

    loadCircles();
  </script>
</body>
</html>
