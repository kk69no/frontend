<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P2P –°–¥–µ–ª–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f0f0);
      --text: var(--tg-theme-text-color, #000);
      --btn: var(--tg-theme-button-color, #2a85ff);
      --btn-text: var(--tg-theme-button-text-color, #fff);
    }
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: #ddd;
      cursor: pointer;
    }
    .tab.active {
      background: #bbb;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      padding: 1rem;
    }
    .tab-content.active {
      display: block;
    }
    input, select {
      width: 100%;
      margin: 0.3rem 0;
      padding: 0.5rem;
      border-radius: 6px;
    }
    button {
      background: var(--btn);
      color: var(--btn-text);
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.3rem 0.2rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .card {
      background: var(--tg-theme-secondary-bg-color, #fff);
      padding: 1rem;
      margin: 0.8rem 0;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">üìÑ –°–¥–µ–ª–∫–∏</div>
    <div class="tab" onclick="switchTab(1)">üìä –ì—Ä–∞—Ñ–∏–∫</div>
    <div class="tab" onclick="switchTab(2)">üîç –§–∏–ª—å—Ç—Ä—ã</div>
    <div class="tab" onclick="switchTab(3)">üìù –õ–æ–≥–∏</div>
  </div>

  <div class="tab-content active">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</h3>
    <select id="type">
      <option value="buy">–ü–æ–∫—É–ø–∫–∞</option>
      <option value="sell">–ü—Ä–æ–¥–∞–∂–∞</option>
    </select>
    <input id="amount" type="number" placeholder="–°—É–º–º–∞ ‚ÇΩ" />
    <input id="currency" placeholder="–í–∞–ª—é—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä USDT)" />
    <input id="price" type="number" placeholder="–¶–µ–Ω–∞ ‚ÇΩ" />
    <input id="note" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" />
    <button onclick="generateNote()">AI-–ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
    <button onclick="addDeal()">–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</button>

    <h4>–ö—Ä—É–≥ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</h4>
    <select id="circleSelect"></select>

    <div id="circles"></div>
  </div>

  <div class="tab-content">
    <canvas id="mainChart"></canvas>
  </div>

  <div class="tab-content">
    <input id="filterCurrency" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –≤–∞–ª—é—Ç–µ" />
    <input id="filterMinPrice" type="number" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞" />
    <input id="filterMaxPrice" type="number" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞" />
    <button onclick="render()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
  </div>

  <div class="tab-content">
    <ul id="logList"></ul>
  </div>

  <script>
    const API = 'https://backend-2wm0.onrender.com';
    Telegram.WebApp.ready();
    const initData = Telegram.WebApp.initData;
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id;
    const initDataHeader = { 'x-init-data': initData };
    let circles = [];

    function switchTab(n) {
      document.querySelectorAll('.tab').forEach((t, i) =>
        t.classList.toggle('active', i === n));
      document.querySelectorAll('.tab-content').forEach((c, i) =>
        c.classList.toggle('active', i === n));
    }

    async function load() {
      const res = await fetch(`${API}/circles`, { headers: initDataHeader });
      circles = await res.json();
      render();
    }

    async function addDeal() {
      const type = document.getElementById("type").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const currency = document.getElementById("currency").value;
      const price = parseFloat(document.getElementById("price").value);
      const note = document.getElementById("note").value;

      if (type === "buy") {
        await fetch(`${API}/circles`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...initDataHeader },
          body: JSON.stringify({ buyAmount: amount })
        });
      } else {
        const idx = document.getElementById("circleSelect").selectedIndex;
        const circle = circles[idx];
        if (!circle) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä—É–≥");
        await fetch(`${API}/circles/${circle.id}/sells`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...initDataHeader },
          body: JSON.stringify({ amount, currency, price, note })
        });
      }

      ["amount","currency","price","note"].forEach(id => document.getElementById(id).value = "");
      await load();
    }

    function render() {
      const list = document.getElementById("circles");
      const select = document.getElementById("circleSelect");
      list.innerHTML = "";
      select.innerHTML = "";

      circles.forEach((c, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.innerText = `–ö—Ä—É–≥ #${i + 1}`;
        select.appendChild(opt);

        const total = c.sells.reduce((s, t) => s + t.amount * t.price, 0);
        const sold = c.buyamount - c.remaining;
        const pnl = total - c.buyamount;
        const percent = ((sold / c.buyamount) * 100).toFixed(2);

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <b>–ö—Ä—É–≥ #${i + 1}</b><br>
          –ö—É–ø–ª–µ–Ω–æ: ${c.buyamount}‚ÇΩ<br>
          –ü—Ä–æ–¥–∞–Ω–æ: ${sold.toFixed(2)}‚ÇΩ<br>
          –í—ã—Ä—É—á–∫–∞: ${total.toFixed(2)}‚ÇΩ<br>
          PnL: ${pnl.toFixed(2)}‚ÇΩ<br>
          –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${percent}%
          <ul>
            ${c.sells.map(s => `<li>${s.amount} ${s.currency} –ø–æ ${s.price}‚ÇΩ ‚Äì ${s.note}</li>`).join("")}
          </ul>
          <button onclick="deleteCircle(${c.id})">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        list.appendChild(div);
      });

      drawChart();
    }

    async function deleteCircle(id) {
      await fetch(`${API}/circles/${id}`, {
        method: "DELETE",
        headers: initDataHeader
      });
      await load();
    }

    function generateNote() {
      const currency = document.getElementById("currency").value;
      const price = document.getElementById("price").value;
      document.getElementById("note").value = `–ü—Ä–æ–¥–∞–∂–∞ ${currency} –ø–æ ${price}‚ÇΩ ‚Äì –≤—ã–≥–æ–¥–Ω–æ`;
    }

    async function drawChart() {
      const ctx = document.getElementById('mainChart').getContext('2d');
      const labels = circles.map((_, i) => `–ö—Ä—É–≥ #${i + 1}`);
      const revenue = circles.map(c =>
        c.sells.reduce((sum, s) => sum + s.amount * s.price, 0));
      const pnl = revenue.map((rev, i) => rev - circles[i].buyamount);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: "–í—ã—Ä—É—á–∫–∞", data: revenue, backgroundColor: "#4caf50" },
            { label: "–ü—Ä–∏–±—ã–ª—å", data: pnl, backgroundColor: "#2196f3" }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      });
    }

    async function loadLogs() {
      const res = await fetch(`${API}/logs`, { headers: initDataHeader });
      const logs = await res.json();
      const list = document.getElementById("logList");
      list.innerHTML = logs.map(l => `<li>${l.action} ‚Äì ${new Date(l.created_at).toLocaleString()}</li>`).join("");
    }

    load();
    loadLogs();
  </script>
</body>
</html>
